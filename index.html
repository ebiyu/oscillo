<!DOCTYPE html>
<!--参考:https://qiita.com/mhagita/items/6c7d73932d9a207eb94d-->
<html>
  <head>
    <meta charset="UTF-8">
    <title>Oscilloscope</title>
    <script src="https://code.jquery.com/jquery-3.2.1.js"></script>
    <style>
    html,body{
        height: 100%;
        background: #333;
    }
    #wrapper{
        width: 100%;
        height: 100%;
    }
    #wave_canvas{
        display: block;
    }
    </style>
    <script>
    //canvasのサイズ調整
    $(function() {
      var canvas = document.getElementById('wave_canvas');
      var container = document.getElementById('wrapper');
      sizing();

      function sizing() {
        canvas.height = container.offsetHeight;
        canvas.width = container.offsetWidth;
      }

      window.addEventListener('resize', function() {
        (!window.requestAnimationFrame) ? setTimeout(sizing, 300): window.requestAnimationFrame(sizing);
      });
    });
    </script>
  </head>
  <body>
    <button onclick="toggleRecording()" id="togglebutton">Run</button>
    <div id="wrapper">
    <canvas id="wave_canvas" width="500" height="500"></canvas>
    </div>
    <!--<canvas id="spectrum_canvas" width="500" height="500"></canvas>-->

    <script>
    // クロスブラウザ定義
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

    // 変数定義
    var localMediaStream = null;
    var localScriptProcessor = null;
    var audioContext=null;
    var bufferSize = 1024;
    var audioData = []; // 録音データ

    var recordingFlg = false;
    var initialized=false;

    // 音声解析
    var audioAnalyser = null;

    // 録音バッファ作成（録音中自動で繰り返し呼び出される）
    function onAudioProcess(e) {
        if (!recordingFlg) return;

        var input = e.inputBuffer.getChannelData(0);
        drawWave(input);
    };
    
    //波形を描画する
    function drawWave(waveData){
        var canvas = document.getElementById('wave_canvas');
        var canvasContext = canvas.getContext('2d');

        var time = bufferSize/audioContext.sampleRate;

        canvasContext.clearRect(0, 0, canvas.width, canvas.height);
        canvasContext.strokeStyle="#0ff";

        canvasContext.beginPath();

        for (var i = 0, len = waveData.length; i < len; i++) {
            //canvasにおさまるように線を描画
            var x = (i / len) * canvas.width;
            var y = (waveData[i]/2+0.5) * canvas.height;
            if (i === 0) {
                canvasContext.moveTo(x, y);
            } else if(i%5==0){
                canvasContext.lineTo(x, y);
            }

            canvasContext.stroke();
        }
    }

    //解析開始
    function toggleRecording() {
        recordingFlg = !recordingFlg;
        document.getElementById("togglebutton").innerHTML = recordingFlg?"Stop":"Run";

        if(initialized) return; //ガード節

        audioContext = new AudioContext();
        navigator.getUserMedia({audio: true}, function(stream) {
            // 録音関連
            localMediaStream = stream;
            var scriptProcessor = audioContext.createScriptProcessor(bufferSize, 1, 1);
            localScriptProcessor = scriptProcessor;
            var mediastreamsource = audioContext.createMediaStreamSource(stream);
            mediastreamsource.connect(scriptProcessor);
            scriptProcessor.onaudioprocess = onAudioProcess;
            scriptProcessor.connect(audioContext.destination);
        },
        function(e) {
            console.log(e);
        });

        initialized=true;
    }
    </script>
  </body>
</html>
